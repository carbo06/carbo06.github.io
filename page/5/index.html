<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/cat-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/cat-32x32.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="About Linux C++ and routing algorithms.">
<meta name="keywords" content="Linux C++ Routing">
<meta property="og:type" content="website">
<meta property="og:title" content="Carbon&#39;s Blog">
<meta property="og:url" content="https://carbo06.github.io/page/5/index.html">
<meta property="og:site_name" content="Carbon&#39;s Blog">
<meta property="og:description" content="About Linux C++ and routing algorithms.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Carbon&#39;s Blog">
<meta name="twitter:description" content="About Linux C++ and routing algorithms.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carbo06.github.io/page/5/"/>





  <title>Carbon's Blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Carbon's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">以梦为马 不负韶华</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/04/10/C-内存数据结构与二进制文件之间的序列化和反序列化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/10/C-内存数据结构与二进制文件之间的序列化和反序列化/" itemprop="url">C++ 内存数据结构与二进制文件之间的序列化和反序列化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-10T19:19:36+08:00">
                2018-04-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-04-11T13:08:22+08:00">
                2018-04-11
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><p>许多后端检索server启动时候需要从文件加载到内存中构建索引，这个过程往往会消耗比较多的时间，这样会造成sever启动消耗比较多的时间，在存在多台服务器的时候会更加明显。<br>我们可以将够构建索引的过程独立成一个单独的进程，此进程实现的功能是根据原始文件构建索引结构，并将索引结构序列化到本地二进制文件，Server在启动的时候只需要读取二进制文件就可以构造出索引结构，可以大大提高启动速度。</p>
<h1 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h1><p>io.hpp ,对std::ifstream 以及std::ofstream 的封装，提供从vector序列化到二进制文件和从二进制文件反序列化到vector等接口<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> IO_HPP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_HPP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileReader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    FileReader(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename)</span><br><span class="line">        : input_stream(filename,<span class="built_in">std</span>::ios::binary)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read count objects of type T into pointer dest */</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">ReadInto</span><span class="params">(T *dest, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> count)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static_assert</span>(<span class="built_in">std</span>::is_trivially_copyable&lt;T&gt;::value,</span><br><span class="line">                      <span class="string">"bytewise reading requires trivially copyable type"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> &amp;result = input_stream.read(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span> *&gt;(dest), count * <span class="keyword">sizeof</span>(T));</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> bytes_read = input_stream.gcount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bytes_read != count * <span class="keyword">sizeof</span>(T) &amp;&amp; !result)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">ReadInto</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt; &amp;target)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ReadInto(target.data(), target.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">ReadInto</span><span class="params">(T &amp;target)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">         ReadInto(&amp;target, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function">T <span class="title">ReadOne</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        T tmp;</span><br><span class="line">        ReadInto(tmp);</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">uint32_t</span> ReadElementCount32()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ReadOne&lt;<span class="built_in">std</span>::<span class="keyword">uint32_t</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">uint64_t</span> ReadElementCount64()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ReadOne&lt;<span class="built_in">std</span>::<span class="keyword">uint64_t</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">DeserializeVector</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt; &amp;data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> count = ReadElementCount64();</span><br><span class="line">        data.resize(count);</span><br><span class="line">        ReadInto(data.data(), count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::ifstream input_stream;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileWriter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    FileWriter(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename)</span><br><span class="line">        : output_stream(filename,<span class="built_in">std</span>::ios::binary)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write count objects of type T from pointer src to output stream */</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">WriteFrom</span><span class="params">(<span class="keyword">const</span> T *src, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> count)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static_assert</span>(<span class="built_in">std</span>::is_trivially_copyable&lt;T&gt;::value,</span><br><span class="line">                      <span class="string">"bytewise writing requires trivially copyable type"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> &amp;result =</span><br><span class="line">            output_stream.write(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(src), count * <span class="keyword">sizeof</span>(T));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">WriteFrom</span><span class="params">(<span class="keyword">const</span> T &amp;target)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WriteFrom(&amp;target, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">WriteOne</span><span class="params">(<span class="keyword">const</span> T tmp)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WriteFrom(tmp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteElementCount32</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">uint32_t</span> count)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WriteOne&lt;<span class="built_in">std</span>::<span class="keyword">uint32_t</span>&gt;(count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteElementCount64</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">uint64_t</span> count)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WriteOne&lt;<span class="built_in">std</span>::<span class="keyword">uint64_t</span>&gt;(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">SerializeVector</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt; &amp;data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> count = data.size();</span><br><span class="line">        WriteElementCount64(count);</span><br><span class="line">        <span class="keyword">return</span> WriteFrom(data.data(), count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::ofstream output_stream;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>binary_io.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"io.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">double</span> b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream&amp; out,<span class="keyword">const</span> Data&amp; data)</span><br><span class="line">    &#123;</span><br><span class="line">        out &lt;&lt; data.a &lt;&lt; <span class="string">","</span> &lt;&lt; data.b;</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printData</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt;&amp; data_vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> data : data_vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&#123;"</span> &lt;&lt; data &lt;&lt; <span class="string">"&#125; "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serializeVector</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename,<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt;&amp; data_vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FileWriter <span class="title">file_writer</span><span class="params">(filename)</span></span>;</span><br><span class="line">    file_writer.SerializeVector&lt;T&gt;(data_vec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserializeVector</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T&gt;&amp; data_vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FileReader <span class="title">file_reader</span><span class="params">(filename)</span></span>;</span><br><span class="line">    file_reader.DeserializeVector&lt;T&gt;(data_vec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Data&gt; vec1 = &#123;&#123;<span class="number">1</span>,<span class="number">1.1</span>&#125;,&#123;<span class="number">2</span>,<span class="number">2.2</span>&#125;,&#123;<span class="number">3</span>,<span class="number">3.3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">4.4</span>&#125;&#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"before write to binary file.\n"</span>;</span><br><span class="line">    printData(vec1);</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> filename = <span class="string">"vector_data"</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"serialize vector to binary file.\n"</span>;</span><br><span class="line">    serializeVector&lt;Data&gt;(filename,vec1);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Data&gt; vec2;</span><br><span class="line">    deserializeVector&lt;Data&gt;(filename,vec2);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"vector read from binary file.\n"</span>;</span><br><span class="line">    printData(vec2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译代码<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">g</span><span class="literal">+</span><span class="literal">+</span> <span class="literal">-</span><span class="comment">std=c</span><span class="literal">+</span><span class="literal">+</span><span class="comment">11</span> <span class="comment">binary_io</span><span class="string">.</span><span class="comment">cpp</span> <span class="literal">-</span><span class="comment">o</span> <span class="comment">binary_io</span></span><br></pre></td></tr></table></figure></p>
<p>执行程序<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./binary_io</span></span><br></pre></td></tr></table></figure></p>
<p>执行结果<br><img src="http://img.blog.csdn.net/20171128192856855?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FyYm9uMDY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="执行结果"><br>程序将内存中vector 数据写入二进制文件，并从二进制文件中反序列化到一个新的vector。可以看到序列化前和序列化后的结果一致。</p>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>序列化到文件的数据结构需要满足 is_trivially_copyable。std::is_trivially_copyable 在c++11 引入，TriviallyCopyable类型对象有以下性质</p>
<pre><code>每个拷贝构造函数是trivial 或者是deleted
每个移动构造函数是trivial 或者是deleted
每个拷贝赋值运算符是trivial 或者是deleted
每个移动赋值运算符是trivial 或者是deleted
以上至少有一个是non-deleted
析构函数是trivial 并且non-deleted
</code></pre><p>对于is_trivially_copyable 类型对象的性质，解释如下</p>
<p>Objects of trivially-copyable types are the only C++ objects that may be safely copied with std::memcpy or serialized to/from binary files with std::ofstream::write()/std::ifstream::read(). In general, a trivially copyable type is any type for which the underlying bytes can be copied to an array of char or unsigned char and into a new object of the same type, and the resulting object would have the same value as the original</p>
<p>只有满足trivially-copyable的对象才可以保证序列化到二进制文件后， 从二进制文件反序列化到内存后的值保持不变。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/04/02/LRU-Cache-解析及实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/LRU-Cache-解析及实现/" itemprop="url">LRU Cache 解析及实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-02T18:02:08+08:00">
                2018-04-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-09-04T11:23:53+08:00">
                2018-09-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LRU-Cache-原理"><a href="#LRU-Cache-原理" class="headerlink" title="LRU Cache 原理"></a>LRU Cache 原理</h2><p>LRU是Least Recently Used 的缩写，是一种缓存替换算法，当系统中的缓存满时，通过删除最近最少使用的元素来填充新的内容。LRU 算法在操作系统中有广泛应用，如CPU与物理内存之间的Cache替换算法， 物理内存与硬盘之间Cache替换算法。</p>
<h2 id="LRU-Cache-实现"><a href="#LRU-Cache-实现" class="headerlink" title="LRU Cache 实现"></a>LRU Cache 实现</h2><p>我们可以使用一个双向链表和hash map 实现LRU Cache，其中hash map 存储缓存的内容，hash map 的value 存储指向双向链表节点的指针，双向链表存储缓存的内容，当有节点被加入时，该节点放到双向列表的头部，当访问已经存在的节点时，把该节点移动到双向链表头部，当双向链表满时，删除双向链表最后一个元素。简单的讲，双向链表的作用是记录缓存内容的使用顺序。</p>
<h2 id="C-实现"><a href="#C-实现" class="headerlink" title="C++ 实现"></a>C++ 实现</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">/*************************************************************************</span><br><span class="line">	&gt; File Name: lru_cache_template.hpp</span><br><span class="line">	&gt; Author: ce39906</span><br><span class="line">	&gt; Mail: ce39906@<span class="number">163</span>.com</span><br><span class="line">	&gt; Created Time: <span class="number">2018</span>-<span class="number">04</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">58</span></span><br><span class="line"> ************************************************************************/</span><br><span class="line"><span class="comment">#ifndef LRU_CACHE_TEMPLATE_HPP</span></span><br><span class="line"><span class="comment">#define LRU_CACHE_TEMPLATE_HPP</span></span><br><span class="line"><span class="comment">#include &lt;unordered_map&gt;</span></span><br><span class="line"></span><br><span class="line">template <span class="tag">&lt;class Key,class Value&gt;</span></span><br><span class="line">struct <span class="keyword">Node</span><span class="title"></span></span><br><span class="line"><span class="title">&#123;</span></span><br><span class="line"><span class="title">    Node</span>(Key k,Value v) :</span><br><span class="line">        key(k), value(v), prev(NULL), next(NULL)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Node</span><span class="title">()</span></span><br><span class="line"><span class="title">    &#123;</span></span><br><span class="line"><span class="title">    &#125;</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">    Key</span> key;</span><br><span class="line">    Value value;</span><br><span class="line">    <span class="keyword">Node</span><span class="title">* prev</span>;</span><br><span class="line">    <span class="keyword">Node</span><span class="title">* next</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template <span class="tag">&lt;class Key, class Value&gt;</span></span><br><span class="line">class LruCache</span><br><span class="line">&#123;</span><br><span class="line">  public:</span><br><span class="line"></span><br><span class="line">    LruCache(int capacity) :</span><br><span class="line">        size_(<span class="number">0</span>), capacity_(capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        head = new <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;;</span><br><span class="line">        tail = new <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;;</span><br><span class="line">        head-&gt;next = tail;</span><br><span class="line">        head-&gt;prev = NULL;</span><br><span class="line">        tail-&gt;next = NULL;</span><br><span class="line">        tail-&gt;prev = head;</span><br><span class="line">        container_.clear();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ~LruCache()</span><br><span class="line">    &#123;</span><br><span class="line">        while(head)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* temp = head-&gt;next;</span><br><span class="line">            delete head;</span><br><span class="line">            head = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    void Put(Key key ,Value value)</span><br><span class="line">    &#123;</span><br><span class="line">        //insert</span><br><span class="line">        if (container_.find(key) == container_.end())</span><br><span class="line">        &#123;</span><br><span class="line">            //not full</span><br><span class="line">            if (size_ != capacity_)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* data = new <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;(key,value);</span><br><span class="line">                attach(data);</span><br><span class="line">                container_.insert(std::make_pair(key,data));</span><br><span class="line">                size_++;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* temp = tail-&gt;prev;</span><br><span class="line">                container_.erase(temp-&gt;key);</span><br><span class="line">                detach(temp);</span><br><span class="line">                if (temp)</span><br><span class="line">                    delete temp;</span><br><span class="line">                <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* data = new <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;(key,value);</span><br><span class="line">                attach(data);</span><br><span class="line">                container_.insert(std::make_pair(key,data));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else //update</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* data = container_[key];</span><br><span class="line">            detach(data);</span><br><span class="line">            if (data)</span><br><span class="line">                delete data;</span><br><span class="line">            data = new <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;(key,value);</span><br><span class="line">            container_[key] = data;</span><br><span class="line">            attach(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Value Get(Key key)</span><br><span class="line">    &#123;</span><br><span class="line">        //find</span><br><span class="line">        if (container_.find(key) != container_.end())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* data = container_[key];</span><br><span class="line">            detach(data);</span><br><span class="line">            attach(data);</span><br><span class="line">            return data-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        else // not find</span><br><span class="line">        &#123;</span><br><span class="line">            return Value();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  private:</span><br><span class="line"></span><br><span class="line">    int size_;</span><br><span class="line">    int capacity_;</span><br><span class="line">    std::unordered_map<span class="tag">&lt;Key,Node&lt;Key,Value&gt;</span>*&gt; container_;</span><br><span class="line">    <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* head;</span><br><span class="line">    <span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* tail;</span><br><span class="line"></span><br><span class="line">    void attach(<span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* <span class="keyword">node</span><span class="title">)</span></span><br><span class="line"><span class="title">    &#123;</span></span><br><span class="line"><span class="title">        Node</span><span class="tag">&lt;Key,Value&gt;</span>* temp = head-&gt;next;</span><br><span class="line">        head-&gt;next = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        node-</span>&gt;next = temp;</span><br><span class="line">        <span class="keyword">node</span><span class="title">-&gt;prev</span> = head;</span><br><span class="line">        temp-&gt;prev = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">    &#125;</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">    void</span> detach(<span class="keyword">Node</span><span class="title">&lt;Key</span>,Value&gt;* <span class="keyword">node</span><span class="title">)</span></span><br><span class="line"><span class="title">    &#123;</span></span><br><span class="line"><span class="title">        node-</span>&gt;prev-&gt;next = <span class="keyword">node</span><span class="title">-&gt;next</span>;</span><br><span class="line">        <span class="keyword">node</span><span class="title">-&gt;next-</span>&gt;prev = <span class="keyword">node</span><span class="title">-&gt;prev</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/03/29/C-Thread-Pool-使用解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/29/C-Thread-Pool-使用解析/" itemprop="url">C++ Thread Pool 使用解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-29T15:03:37+08:00">
                2018-03-29
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-03-29T15:19:41+08:00">
                2018-03-29
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="boost-threadpool"><a href="#boost-threadpool" class="headerlink" title="boost::threadpool"></a>boost::threadpool</h2><p> 按照boost标准开发的第三方库。下载地址在<a href="http://threadpool.sourceforge.net/" target="_blank" rel="noopener">boost::threadpool</a> 使用方法较为简单。例子如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"boost/bind.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"boost/threapool.hpp"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> threadpool;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">first_task</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"first task"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">second_task</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"second task"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">task_with_parameter</span><span class="params">(<span class="keyword">int</span> value,<span class="built_in">string</span> str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"task with parameter,value is: "</span> &lt;&lt; value &lt;&lt;<span class="string">",str is: "</span> &lt;&lt; str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 声明线程池</span></span><br><span class="line">    <span class="function">pool <span class="title">thread_pool</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向线程池中添加任务</span></span><br><span class="line">    thread_pool.schedule(&amp;first_task);</span><br><span class="line">    <span class="comment">// 等待线程函数执行完成</span></span><br><span class="line">    thread_pool.wait();</span><br><span class="line">    thread_pool.schedule(&amp;second_task);</span><br><span class="line">    thread_pool.schedule(boost::bind(task_with_parameter,<span class="number">8</span>,<span class="string">"hello"</span>));</span><br><span class="line">    thread_pool.wait();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>boost::threadpool 添加任务，同步方式都相对简单，在添加多参数的任务时候需要注意 boost::bind() 传递的参数是按照拷贝的方式传递的。如果想使用引用的方式传递的话，需要使用boost::ref() 或者boost::cref()。<strong><em>还有需要注意的是boost::bind()最多接受九个参数</em></strong><br>boost::threadpool 是相对比较老的一个库,在2005-2008年间更新</p>
<h2 id="boost-thread-group-以及io-service"><a href="#boost-thread-group-以及io-service" class="headerlink" title="boost::thread_group 以及io_service"></a>boost::thread_group 以及io_service</h2><p> 例子<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/asio/io_service.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost::bind.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost::thread/thread_group.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="symbol">boost:</span>:<span class="symbol">asio::</span>io_service ioService;</span><br><span class="line"><span class="symbol">boost:</span>:thread_group threadpool;</span><br><span class="line"><span class="comment">/*The work class is used to inform the io_service when</span></span><br><span class="line"><span class="comment">work starts and finishes. This ensures that the</span></span><br><span class="line"><span class="comment">io_service object's run() function will not exit</span></span><br><span class="line"><span class="comment">while work is underway, and that it does exit when</span></span><br><span class="line"><span class="comment">there is no unfinished work remaining</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 声明一个ioService work 的原因是为了保证io service</span></span><br><span class="line"><span class="comment">的run方法在这个work销毁之前不会退出</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="symbol">boost:</span>:<span class="symbol">asio::</span><span class="symbol">io_service::</span>work work(ioService);</span><br><span class="line"><span class="comment">// 放在for循环中，根据线程池中线程中个数创建</span></span><br><span class="line"><span class="comment">// ioService 可以理解为任务队列</span></span><br><span class="line"><span class="comment">//Run the io_service object's event processing loop.</span></span><br><span class="line">threadpool.create_thread(<span class="symbol">boost::</span>bind(<span class="variable">&amp;boost</span>::<span class="symbol">asio::</span><span class="symbol">ioservice::</span>run,&amp;ioService));</span><br><span class="line">threadpool.create_thread(<span class="symbol">boost::</span>bind(<span class="variable">&amp;boost</span>::<span class="symbol">asio::</span><span class="symbol">ioservice::</span>run,&amp;ioService));</span><br><span class="line"><span class="comment">// 向ioService 中提交任务</span></span><br><span class="line">ioService.post(<span class="symbol">boost::</span>bind(myTask,<span class="string">"hello world"</span>));</span><br><span class="line">ioService.post(<span class="symbol">boost::</span>bind(myTask2,<span class="string">"clear"</span>));</span><br><span class="line">...</span><br><span class="line"><span class="comment">// ioService 在stop 之后，post到ioService中的task 都不会被执行</span></span><br><span class="line">ioService.stop();</span><br><span class="line">threadpool.join_all();</span><br></pre></td></tr></table></figure></p>
<p>boost::ioservice 以及 boost::thread_pool 实现的thread pool没有提供wait() 方法，因此需要调用者主动判断所提交的任务有没有完成</p>
<h2 id="基于c-11-实现的线程池"><a href="#基于c-11-实现的线程池" class="headerlink" title="基于c++11 实现的线程池"></a>基于c++11 实现的线程池</h2><p>主要步骤如下：</p>
<ul>
<li><p>设定线程池中所提供的服务线程数</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">int threads</span> = thread::hardware_concurrency();</span><br></pre></td></tr></table></figure>
</li>
<li><p>每个线程都应该执行一个无限循环，无限循环中等待新任务到达，并执行任务</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;thread&gt; pool;</span><br><span class="line"><span class="keyword">for</span> (int i = 0; i &lt; threads; i++)</span><br><span class="line">&#123;</span><br><span class="line">    pool.push_back(thread(Infinite_loop_function));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>无限循环function</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        unique_lock&lt;mutex&gt; lock(queue_mutex);</span><br><span class="line">        condition.wait(lock,[]&#123;<span class="keyword">return</span> !Queue.empty()&#125;);</span><br><span class="line">        <span class="keyword">Task</span> = Queue.front();</span><br><span class="line">        Queue.<span class="keyword">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Task</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>向任务队列中添加任务</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> enqueue(<span class="keyword">function</span>&lt;<span class="keyword">void</span>()&gt; <span class="keyword">new</span><span class="number">_</span>task)</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        unique<span class="number">_</span>lock&lt;mutex&gt; lock(queue<span class="number">_m</span>utex);</span><br><span class="line">        Queue.push(<span class="keyword">new</span><span class="number">_</span>task);</span><br><span class="line">    &#125;</span><br><span class="line">    condition.notify<span class="number">_</span>one();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体实现例子<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ThreadPool(size_t threads) : stop(<span class="keyword">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(size_t i = <span class="number">0</span>;i&lt;threads;++i)</span><br><span class="line">            workers.emplace_back(</span><br><span class="line">                [this]</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span>(;;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        std::function&lt;void()&gt; task;</span><br><span class="line">                        &#123;</span><br><span class="line">                            std::unique_lock&lt;std::mutex&gt; lock(this-&gt;queue_mutex);</span><br><span class="line">                            this-&gt;condition.wait(lock,</span><br><span class="line">                                [this]&#123; <span class="keyword">return</span> this-&gt;stop || !this-&gt;tasks.<span class="keyword">empty</span>(); &#125;);</span><br><span class="line">                            <span class="keyword">if</span>(this-&gt;stop &amp;&amp; this-&gt;tasks.<span class="keyword">empty</span>())</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                            task = std::move(this-&gt;tasks.front());</span><br><span class="line">                            this-&gt;tasks.pop();</span><br><span class="line">                        &#125;</span><br><span class="line">                        task();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// add new work item to the pool</span></span><br><span class="line">    void enqueue(std::function&lt;void()&gt;&amp; task)</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            std::unique_lock&lt;std::mutex&gt; lock(queue_mutex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// don't allow enqueueing after stopping the pool</span></span><br><span class="line">            <span class="keyword">if</span>(stop)</span><br><span class="line">                <span class="keyword">throw</span> std::runtime_error(<span class="string">"enqueue on stopped ThreadPool"</span>);</span><br><span class="line"></span><br><span class="line">            tasks.emplace(task);</span><br><span class="line">        &#125;</span><br><span class="line">        condition.notify_one();</span><br><span class="line">    &#125;</span><br><span class="line">    ~ThreadPool()</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            std::unique_lock&lt;std::mutex&gt; lock(queue_mutex);</span><br><span class="line">            stop = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        condition.notify_all();</span><br><span class="line">        <span class="keyword">for</span>(std::thread &amp;worker: workers)</span><br><span class="line">            worker.join();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt; std::thread &gt; workers;</span><br><span class="line">    <span class="comment">// the task queue</span></span><br><span class="line">    std::queue&lt; std::function&lt;void()&gt; &gt; tasks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// synchronization</span></span><br><span class="line">    std::mutex queue_mutex;</span><br><span class="line">    std::condition_variable condition;</span><br><span class="line">    <span class="keyword">bool</span> stop;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从线程池的实现可以看到，线程在任务队列中获取任务以及向任务队列中提交任务都需要抢占队列的互斥锁，会造成时间损耗，尤其在<strong><em>任务数多，每个任务需要的时间不是很长</em></strong>的情况下，抢占任务队列互斥锁的时间损耗就显得更加明显。例如，在16核机器，线程池开启14个线程，向线程池中提交2000个task(每个task耗时1ms 左右)的情况下，向线程池提交任务所需时间约20ms。<br>因此，线程池的方式更适合<strong><em>每个task消耗的时间比较长，任务数不是特别多的场景</em></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/03/28/Boost-Spirit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/28/Boost-Spirit/" itemprop="url">Boost Spirit</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-28T15:53:11+08:00">
                2018-03-28
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-08-01T19:22:18+08:00">
                2018-08-01
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-boost-spirit"><a href="#What-is-boost-spirit" class="headerlink" title="What is boost spirit"></a>What is boost spirit</h1><p>boost spirit is an object-oriented,recursive-descent parser and output generation library for C++.It allows you to write grammars and format descripting using a format similar to Extended Backs Naur Form(EBNF) directly in C++.</p>
<p>The figure below shows the overall structure of Boost Spirit library.</p>
<p><img src="http://www.boost.org/doc/libs/1_64_0/libs/spirit/doc/html/images/spiritstructure.png" alt="image"></p>
<p>The three components Qi,Kama and Lex are designed to be used either stand alone or together. The general methodology is to use the token sequence generated by Lex as the input for a parser generated by Qi. On the opposite side of the equation,the hierarchical data structures generated by Qi are used for the output generators created using Kama.</p>
<p>The place of Spirit.Qi and Spirit.Kama in a data transformation flow of a typical application.</p>
<p><img src="http://www.boost.org/doc/libs/1_64_0/libs/spirit/doc/html/images/spiritkarmaflow.png" alt="image"></p>
<h2 id="Qi-Writing-Parsers"><a href="#Qi-Writing-Parsers" class="headerlink" title="Qi- Writing Parsers"></a>Qi- Writing Parsers</h2><p>Spirit.Qi is designed to be a practical parsing tool. Scanf ,boost::regex or boost::tokenizer do not scale well when we need to write more elaborate parsers.</p>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><h4 id="Example-1-parsing-a-number"><a href="#Example-1-parsing-a-number" class="headerlink" title="Example #1 parsing a number"></a>Example #1 parsing a number</h4><p>Create a parser that will parse a floating-point number.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double_</span><br></pre></td></tr></table></figure></p>
<h4 id="Example-2-parsing-2-numbers"><a href="#Example-2-parsing-2-numbers" class="headerlink" title="Example #2  parsing 2 numbers"></a>Example #2  parsing 2 numbers</h4><p>Create a parser that will accept a line consisting of 2 floating-point numbers.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double<span class="number">_</span> <span class="meta">&gt;&gt; </span>double<span class="number">_</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Example-3-parsing-zero-or-more-numbers"><a href="#Example-3-parsing-zero-or-more-numbers" class="headerlink" title="Example #3 parsing zero or more numbers"></a>Example #3 parsing zero or more numbers</h4><p>Create a parser that will accept zero or more floating-point numbers.<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">*double_</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Example-4-parsing-a-comma-delimited-list-of-numbers"><a href="#Example-4-parsing-a-comma-delimited-list-of-numbers" class="headerlink" title="Example #4 parsing a comma-delimited list of numbers"></a>Example #4 parsing a comma-delimited list of numbers</h4><p>This example will create a parser that accepts a comma-delimited list of numbers.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double<span class="number">_</span> <span class="meta">&gt;&gt; </span>*(char<span class="number">_</span>(<span class="string">','</span>) &gt;&gt; double<span class="number">_</span>)</span><br></pre></td></tr></table></figure></p>
<p>Notice char_(‘,’) is a literal charcter parser that can recognize the comma ‘,’.</p>
<h4 id="Let’s-Parse"><a href="#Let’s-Parse" class="headerlink" title="Let’s Parse"></a>Let’s Parse</h4><p>We are done with defining the parser.So the next step is invoking this parser to do its work.Here we will use <strong>phrase_parse</strong> function. One overload of this function accepts four arguments.</p>
<ol>
<li>iterator pointing to the start of the input.</li>
<li>iterator pointing to the end of the input.</li>
<li>parser object</li>
<li>another parser called the skip parser</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">parse_numbers</span><span class="params">(Iterator first, Iterator last)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> qi::double_;</span><br><span class="line">    <span class="keyword">using</span> qi::phrase_parse;</span><br><span class="line">    <span class="keyword">using</span> ascii::space;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> r = pharse_parse(</span><br><span class="line">        first,</span><br><span class="line">        last,</span><br><span class="line">        double_ &gt;&gt; *(<span class="string">','</span> &gt;&gt; double_),</span><br><span class="line">        space</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (fisrt != last) </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Parser-Semantic-Actions"><a href="#Parser-Semantic-Actions" class="headerlink" title="Parser Semantic Actions"></a>Parser Semantic Actions</h3><p>The previous example was very simple.It only recognized data,but did noting with it.Now we want to extract information from what was parsed.<br>Semantic actions may be attached to any point in the grammar specification. These functions are C++ functions or function objects that are called whenever a part of the parser successfully recognizes a portion of the input.</p>
<h4 id="Example-of-Semantic-Actions"><a href="#Example-of-Semantic-Actions" class="headerlink" title="Example of Semantic Actions"></a>Example of Semantic Actions</h4><ul>
<li>using plain function pointer</li>
<li>using simple function object</li>
<li>using boost.bind with a plain function</li>
<li>using boost.bind with a member function</li>
<li>using boost.lambda</li>
</ul>
<p>Such as:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> client</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> qi = boost::qi;</span><br><span class="line">    <span class="comment">// A plain function</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; i)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// A member function</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">writer</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; i)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// A function object</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">print_action</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp; i,qi::unset_type,qi::unset_type)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>All examples parse inputs of the form:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;integer&#125;"</span></span><br></pre></td></tr></table></figure></p>
<p>These below shows the usages</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> boost::spirit::qi::int_;</span><br><span class="line"><span class="keyword">using</span> boost::spirit::qi::parse;</span><br><span class="line"><span class="keyword">using</span> client::print;</span><br><span class="line"><span class="keyword">using</span> client::writer;</span><br><span class="line"><span class="keyword">using</span> clinet::print_action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* fisrt = <span class="string">"&#123;43&#125;"</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* last = first + <span class="built_in">std</span>::<span class="built_in">strlen</span>(first);</span><br><span class="line"></span><br><span class="line"><span class="comment">// example using plain function</span></span><br><span class="line">parse(first,last,<span class="string">'&#123;'</span>&gt;&gt;int_[&amp;print]&gt;&gt;<span class="string">'&#125;'</span>);</span><br><span class="line"><span class="comment">// example using simple function object</span></span><br><span class="line">parse(first,last,<span class="string">'&#123;'</span>&gt;&gt;int_[print_action()]&gt;&gt;<span class="string">'&#125;'</span>);</span><br><span class="line"><span class="comment">// example using boost bind with a plain function</span></span><br><span class="line">parse(fisrt,last,<span class="string">'&#123;'</span> &gt;&gt; int_[boost::bind(&amp;print,_1)]&gt;&gt;<span class="string">'&#125;'</span>);</span><br><span class="line"><span class="comment">// example using boost bind with a member function</span></span><br><span class="line">parse(first,last,<span class="string">'&#123;'</span>&gt;&gt; int_[boost::bind(&amp;writer::print,&amp;w,_1)]&gt;&gt;<span class="string">'&#125;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// example using boost lambda</span></span><br><span class="line"><span class="keyword">namespace</span> lambda = boost::lambda;</span><br><span class="line"><span class="keyword">using</span> lambda::_1;</span><br><span class="line">parse(first,last,<span class="string">'&#123;'</span> &gt;&gt; int_[<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; _1 &lt;&lt; <span class="string">'\n'</span>] &gt;&gt; <span class="string">'&#125;'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Phoenix"><a href="#Phoenix" class="headerlink" title="Phoenix"></a>Phoenix</h4><p>Phoenix , a companion library bundled with Spirit. is sepcifically suited for binding semantic actions. It is like Boost.lambad on sterodis, with spiecial custom featrues that make it easy to  inergrate semantic action with Spirit.</p>
<h3 id="Complex-Our-first-complex-parser"><a href="#Complex-Our-first-complex-parser" class="headerlink" title="Complex - Our first complex parser"></a>Complex - Our first complex parser</h3><p>A parser that parses complex numbers.This time we are using Phoenix to do the semantic actions.<br>Here is a simple parser expression for complex numbers.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'('</span> <span class="meta">&gt;&gt; </span>double<span class="number">_</span> &gt;&gt; -(<span class="string">','</span> &gt;&gt; double<span class="number">_</span>) &gt;&gt; <span class="string">')'</span> </span><br><span class="line"><span class="params">| double_</span></span><br></pre></td></tr></table></figure></p>
<p>This parser can parse complex numbers of the form:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(123<span class="selector-class">.22</span>,2121<span class="selector-class">.21</span>)</span><br><span class="line">(213<span class="selector-class">.33</span>)</span><br><span class="line">212<span class="selector-class">.33</span></span><br></pre></td></tr></table></figure></p>
<p>This below shows example of action with phoniex</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> client</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator&gt;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">parse_complex</span><span class="params">(Iterator first,Iterator last,<span class="built_in">std</span>::<span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;&amp; c)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> boost::spirit::qi::double_;</span><br><span class="line">        <span class="keyword">using</span> boost::spirit::qi::_1;</span><br><span class="line">        <span class="keyword">using</span> boost::spirit::qi::phrase_parse;</span><br><span class="line">        <span class="keyword">using</span> boost::spirit::ascii::space;</span><br><span class="line">        <span class="keyword">using</span> boost::phoenix::ref;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">double</span> rN = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">double</span> iN = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">bool</span> r = phrase_parse(</span><br><span class="line">            first,</span><br><span class="line">            last,</span><br><span class="line">            (</span><br><span class="line">                <span class="string">'('</span> &gt;&gt; double_[ref(rN) = _1]</span><br><span class="line">                    &gt;&gt; -(<span class="string">','</span> &gt;&gt; double_[ref(iN) = _1]) &gt;&gt; <span class="string">')'</span> </span><br><span class="line">                | double_[ref(rN) = _1]</span><br><span class="line">            ),</span><br><span class="line">            space</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!r || first != last)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        c = <span class="built_in">std</span>::<span class="keyword">complex</span>&lt;<span class="keyword">double</span>&gt;(rN,iN);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Sum-adding-numbers"><a href="#Sum-adding-numbers" class="headerlink" title="Sum - adding numbers"></a>Sum - adding numbers</h3><p>Here is a parser that sums a comma-separated list of numbers.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">namespace qi = boost::spirit::qi;</span><br><span class="line">namespace ascii = boost::spirit::ascii;</span><br><span class="line">namespace phoenix = boost::spirit::phoenix;</span><br><span class="line"></span><br><span class="line">using qi::double_;</span><br><span class="line">using qi::_1;</span><br><span class="line">using ascii::space;</span><br><span class="line">using phoenix::<span class="keyword">ref</span>;</span><br><span class="line"></span><br><span class="line">template&lt;typename <span class="built_in">Iterator</span>&gt;</span><br><span class="line"><span class="built_in">bool</span> adder(<span class="built_in">Iterator</span> first,<span class="built_in">Iterator</span> last,double&amp; n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">bool</span> r = qi::phrase_parse(</span><br><span class="line">        first,</span><br><span class="line">        last,</span><br><span class="line">        (</span><br><span class="line">            double_[<span class="keyword">ref</span>(n) = _1] &gt;&gt; *(<span class="string">','</span> &gt;&gt; double_[<span class="keyword">ref</span>(n) += _1])</span><br><span class="line">        ),</span><br><span class="line">        space</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (fisrt != last)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Number-List-stuffing-numbers-into-a-std-vector"><a href="#Number-List-stuffing-numbers-into-a-std-vector" class="headerlink" title="Number List - stuffing numbers into a std::vector"></a>Number List - stuffing numbers into a std::vector</h3><p>This sample demonstrates a parser for a comma separated list of numbers. The numbers are inserted in a vector using phoenix.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Iterator&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">parse_numbers</span><span class="params">(Iterator fisrt,Iterator last,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> qi::double_;</span><br><span class="line">    <span class="keyword">using</span> qi::phrase_parse;</span><br><span class="line">    <span class="keyword">using</span> qi::_1;</span><br><span class="line">    <span class="keyword">using</span> ascii::space;</span><br><span class="line">    <span class="keyword">using</span> phoenix::push_back;</span><br><span class="line">    <span class="keyword">using</span> phoenix::ref;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> r = phrase_parse(</span><br><span class="line">        first,</span><br><span class="line">        last,</span><br><span class="line">        (</span><br><span class="line">            double_[push_back(ref(v),_1)] &gt;&gt;</span><br><span class="line">            *(<span class="string">','</span> &gt;&gt; double_[push_back(ref(v),_1)])</span><br><span class="line">        ),</span><br><span class="line">        space</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(first != last)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Number-List-Redux-list-syntax"><a href="#Number-List-Redux-list-syntax" class="headerlink" title="Number List Redux - list syntax"></a>Number List Redux - list syntax</h3><p>So far, we’ve been using the syntax:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double<span class="number">_</span> <span class="meta">&gt;&gt; </span>*(<span class="string">','</span> &gt;&gt; double<span class="number">_</span>)</span><br></pre></td></tr></table></figure></p>
<p>to parse a comma-delimited list of numbers.Such lists are common in parsing and Spirit provides a simpler shortcut for them<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double_ <span class="meta">%</span> <span class="string">','</span></span><br></pre></td></tr></table></figure></p>
<p>reads as a list of doubles separted by ‘,’.<br>The last example could be done as this:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">parse_numbers</span><span class="params">(Iterator first,Iterator last,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt;&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> qi::double_;</span><br><span class="line">    <span class="keyword">using</span> qi::phrase_parse;</span><br><span class="line">    <span class="keyword">using</span> qi::_1;</span><br><span class="line">    <span class="keyword">using</span> ascii::space;</span><br><span class="line">    <span class="keyword">using</span> phoenix::push_back;</span><br><span class="line">    <span class="keyword">using</span> phoenix::ref;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> r = phrase_parse(</span><br><span class="line">        first,</span><br><span class="line">        last,</span><br><span class="line">        (</span><br><span class="line">            double_[ref(v),_1] % <span class="string">','</span></span><br><span class="line">        ),</span><br><span class="line">        space</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (first != last)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Number-List-Attribute-one-more-with-style"><a href="#Number-List-Attribute-one-more-with-style" class="headerlink" title="Number List Attribute - one more,with style"></a>Number List Attribute - one more,with style</h3><p>As we know,the <strong>double_</strong> parser has a doubel attribute. All parsers have an attribute,even complex parsers.</p>
<p>Our parser<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doubel_ <span class="meta">%</span> <span class="string">','</span></span><br></pre></td></tr></table></figure></p>
<p>has an attribute of std::vector<double>.<br>So we can simply pass in a std::vector<double> to our number of list parser.the overload of phrase_parse has five arguments:</double></double></p>
<ol>
<li>iterator pointing to start of the input</li>
<li>iterator pointing to last of the input</li>
<li>the parser object</li>
<li>another parser called skip parser</li>
<li>the parse’s attribute</li>
</ol>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bool r = phrase_parse(</span><br><span class="line">    first,</span><br><span class="line">    last,</span><br><span class="line">    (</span><br><span class="line">        double_ % ','</span><br><span class="line">    ),</span><br><span class="line">    space,</span><br><span class="line">    v</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="Roman-Numerals"><a href="#Roman-Numerals" class="headerlink" title="Roman Numerals"></a>Roman Numerals</h3><p>This example demonstrates:</p>
<ul>
<li>symbol table</li>
<li>rule</li>
<li>grammar</li>
</ul>
<h4 id="Symbol-table"><a href="#Symbol-table" class="headerlink" title="Symbol table"></a>Symbol table</h4><p>Each entry in a symbol table has an associated mutable data solt. In this regard, one can view the symbol table as an associative container of key-value pairs where the keys are strings.</p>
<p>Here is a parser for roman hundreds(100..900) using the symbol table. Keep in mind that the data associated with each slot is the parser’s attribute(which is passed to attached semantic actions).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hundreds_</span> :</span> qi::symbols&lt;<span class="keyword">char</span>, <span class="keyword">unsigned</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    hundreds_()</span><br><span class="line">    &#123;</span><br><span class="line">        add</span><br><span class="line">        (<span class="string">"C"</span>,<span class="number">100</span>)</span><br><span class="line">        (<span class="string">"CC"</span>,<span class="number">200</span>)</span><br><span class="line">        (<span class="string">"CCC"</span>,<span class="number">300</span>)</span><br><span class="line">        (<span class="string">"CD"</span>,<span class="number">400</span>)</span><br><span class="line">        (<span class="string">"D"</span>, <span class="number">500</span>)</span><br><span class="line">        (<span class="string">"DC"</span>, <span class="number">600</span>)</span><br><span class="line">        (<span class="string">"DCC"</span>,<span class="number">700</span>)</span><br><span class="line">        (<span class="string">"DCCC"</span>,<span class="number">800</span>)</span><br><span class="line">        (<span class="string">"CM"</span>,<span class="number">900</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; hundreds;</span><br></pre></td></tr></table></figure>
<p>we also can define tens ones symbol table.They are all parsers.</p>
<h4 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h4><p>Up until now,we have been inlining our parser expressions, passing them directly to the <strong><em>phrase_parse</em></strong> function. The expression evalutes into a temporary,unnamed parser which is passed into the <strong><em>phrase_parse</em></strong> function, used and then destroyed. This is fine for small parsers. When the expressions get complicated, you’d want to break the expressions into smaller easier-to-understand pieces, name them, and refer to them from other expressions by name.</p>
<p>A parser expression can be assigned to what is called a “rule”.Threr are various ways to declare rules.The simplest form is :<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">rule</span>&lt;<span class="keyword">Iterator&gt; </span>r<span class="comment">;</span></span><br><span class="line">// this rule cannot used <span class="keyword">by </span>phrase_parse <span class="meta">function</span>,</span><br><span class="line">// <span class="keyword">it </span>can only <span class="keyword">be </span>used <span class="keyword">by </span>parse <span class="meta">function</span> -- a version that does not do white <span class="meta">space</span> skipping.</span><br><span class="line">// <span class="meta">If</span> you want to have <span class="keyword">it </span>skip white spaces,you need to pass in the type skip parser.</span><br><span class="line"><span class="symbol">rule</span>&lt;<span class="keyword">Iterator,Skipper&gt; </span>r<span class="comment">;</span></span><br><span class="line"><span class="symbol">rule</span>&lt;<span class="keyword">string::iterator,space_type&gt; </span>r<span class="comment">;</span></span><br><span class="line">// This type of rule can <span class="keyword">be </span>used for <span class="keyword">both</span></span><br><span class="line"><span class="keyword">// </span>phrase_parse <span class="keyword">and </span>parse.</span><br></pre></td></tr></table></figure></p>
<p>There is one more rule form you should know about.<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rule</span><span class="variable">&lt;Iterator,Signature,Skipper&gt;</span> r;</span><br></pre></td></tr></table></figure></p>
<p>The Signature specifies athe attributes of the rule. Recall that the double_ parser has an attribute of double. To be precise, these are <strong>synthesized</strong> attributes.The parser “synthesized” the attribute value.Think of them as the function return value.</p>
<p>There is another type of attribute called “inherited” attribute. You can think them as function arguments. And,rightly so, the rule signature is a function signature .</p>
<p>After having declared a rule,you can now assign any parser expression to it. Example:<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">r</span> = double_ &gt;&gt; *(<span class="string">','</span> &gt;&gt; double_);</span><br></pre></td></tr></table></figure></p>
<h4 id="Grammars"><a href="#Grammars" class="headerlink" title="Grammars"></a>Grammars</h4><p>A grammar encapsulates one or more rules.It has the same template parameters as the rule.You can declare a grammar by:</p>
<ol>
<li>deriving a struct from the grammar class template</li>
<li>declare one or more rules as member variables</li>
<li>initialize the base grammar class by giving it the start rule(its the first rule that gets called when the grammar starts parsing)</li>
<li>initalize your rules in your constrctor.</li>
</ol>
<p>The rommon numeral grammar is a very nice and simple example of a grammar.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">roman</span> :</span>qi::grammar&lt;Iterator,<span class="keyword">unsigned</span>()&gt;</span><br><span class="line">&#123;</span><br><span class="line">    roman() : roman::base_type(start)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> qi::eps;</span><br><span class="line">        <span class="keyword">using</span> qi::lit;</span><br><span class="line">        <span class="keyword">using</span> qi::_val;</span><br><span class="line">        <span class="keyword">using</span> qi::_1;</span><br><span class="line">        <span class="keyword">using</span> ascii::char_;</span><br><span class="line">        </span><br><span class="line">        start = eps [_val = <span class="number">0</span>] &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                +lit(<span class="string">'M'</span>)   [_val += <span class="number">1000</span>]</span><br><span class="line">                || hundreds [_val += _1]</span><br><span class="line">                || tens     [_val += _1]</span><br><span class="line">                || ones     [_val += _1]</span><br><span class="line">            )</span><br><span class="line">    &#125;</span><br><span class="line">    qi::rule&lt;Iterator,<span class="keyword">unsigned</span>()&gt;  start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>the grammar and start rule sinature is unsigned() it has a synthesized attribute(return value) of type unsigned whith on inherited attributeds(argumnents).</li>
<li>roman::base_type is a typedef for grammar&lt;Iterator,unsigned()&gt;</li>
<li>_val is another Phoenix placeholder representing the rule’s synthesized attribute</li>
<li>eps is a special spirit parser that consumes no input but is always successful. We use it to initialize _val,the rule’s synthesized attribute, to zero before anything else. Using eps this way is good for doing pre and post initializations.</li>
<li>the example a || b reads, match a or b and in sequence.That is if both a and b match, it must be in sequence; this is equivalen to a &gt;&gt; -b | b,but more efficient.</li>
</ol>
<p>Usage<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> r = parse(iter,end,roman_parser,result);</span><br><span class="line"><span class="keyword">if</span> (r &amp;&amp; iter == end)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Parse success.\n"</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Result = "</span> &lt;&lt; result &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Employee-Pasing-into-structs"><a href="#Employee-Pasing-into-structs" class="headerlink" title="Employee - Pasing into structs"></a>Employee - Pasing into structs</h3><p>This section shows how to parse and place the reult into a C++ struct.</p>
<p>fisrtly, let’s create a struct representing an employee.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">employee</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> surname;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> forename;</span><br><span class="line">    <span class="keyword">double</span> salary;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>now we will write a parser for our employee. Inputs will be of the form.<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">employee&#123; age,<span class="string">"surname"</span>,<span class="string">"forename"</span>,salary &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename Iterator&gt;</span><br><span class="line">struct employee_parser : qi::grammar&lt;Iterator,employee(),ascii::space_type&gt;</span><br><span class="line">&#123;</span><br><span class="line">    employee_parser()<span class="symbol">:employee_parser</span><span class="symbol">:</span><span class="symbol">:base_type</span>(start)</span><br><span class="line">    &#123;</span><br><span class="line">        using qi::int<span class="number">_</span>;</span><br><span class="line">        using qi::lit;</span><br><span class="line">        using qi::double<span class="number">_</span>;</span><br><span class="line">        using qi::lexeme;</span><br><span class="line">        using ascii::char<span class="number">_</span>;</span><br><span class="line">        </span><br><span class="line">        quoted_string %= lexeme[<span class="string">'"'</span> <span class="meta">&gt;&gt; </span>+(char<span class="number">_</span> - <span class="string">'"'</span>) &gt;&gt; <span class="string">'"'</span>];</span><br><span class="line">        </span><br><span class="line">        start %= </span><br><span class="line">            lit(<span class="string">"employee"</span>)</span><br><span class="line">            <span class="meta">&gt;&gt; </span><span class="string">'&#123;'</span></span><br><span class="line">            <span class="meta">&gt;&gt; </span>int<span class="number">_</span> &gt;&gt; <span class="string">','</span></span><br><span class="line">            <span class="meta">&gt;&gt; </span>quoted_string &gt;&gt; <span class="string">','</span></span><br><span class="line">            <span class="meta">&gt;&gt; </span>quoted_string &gt;&gt; <span class="string">','</span></span><br><span class="line">            <span class="meta">&gt;&gt; </span>double<span class="number">_</span></span><br><span class="line">            <span class="meta">&gt;&gt; </span><span class="string">'&#125;'</span></span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    qi::rule&lt;Iterator,std::string(),ascii::space_type&gt; quoted_string;</span><br><span class="line">    qi::rule&lt;Iterator,employee(),ascii::space_type&gt; start;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Lexeme"><a href="#Lexeme" class="headerlink" title="Lexeme"></a>Lexeme</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lexeme[<span class="string">'"'</span> <span class="meta">&gt;&gt;</span>(char<span class="number">_</span> - <span class="string">'"'</span>) &gt;&gt; <span class="string">'"'</span>]</span><br></pre></td></tr></table></figure>
<p>lexeme inhibits sapce skipping from the open brace to the closing space.The expression parses quoted strings.<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+(char_ - '"')</span><br></pre></td></tr></table></figure></p>
<p>parses one or more chars,except the double quote. It stops when it sees a double quote.</p>
<p>+a matches one or more,its attribute is a std::vector<a> where A is the attribute of a .</a></p>
<h4 id="Sequence-Attribute"><a href="#Sequence-Attribute" class="headerlink" title="Sequence Attribute"></a>Sequence Attribute</h4><p>now what’s the attribute of<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'"'</span> <span class="meta">&gt;&gt; </span>(char<span class="number">_</span> - <span class="string">'"'</span>) &gt;&gt;<span class="string">'"'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">a</span> &gt;&gt; <span class="selector-tag">b</span> &gt;&gt; c </span><br><span class="line">fusion::vector&lt;A,B,C&gt;</span><br><span class="line"><span class="comment">// is a tuple</span></span><br></pre></td></tr></table></figure>
<p>Some parser,especially those very little parsers like ‘“‘ do not have attributes.<br>Nodes without attributes are disregarded.<br>so, ‘“‘ &gt;&gt; (char_ - ‘“‘) &gt;&gt;’”‘  ‘s attribue is<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fusion::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>but there is one more collpase rule.if the attribute is followed by a single element fusion::vector, The element is stripped naked from its container. so the attribute come to this<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="Auto-Rules"><a href="#Auto-Rules" class="headerlink" title="Auto Rules"></a>Auto Rules</h4><p>it is typical to see rules like<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">r</span> = p[_val = _1]</span><br></pre></td></tr></table></figure></p>
<p>if you have a rule definiton such as the above,where the attribute of the right hand side of the rule is compitable with the left hand side.then you can rewrite is as:<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r %= p<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>so<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quoted_string %= lexeme[<span class="string">'"'</span> <span class="meta">&gt;&gt; </span>+( char<span class="number">_</span> -<span class="string">'"'</span>) &gt;&gt; <span class="string">'"'</span>];</span><br></pre></td></tr></table></figure></p>
<p>is simple version of<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quoted_string = lexeme[<span class="string">'"'</span> <span class="meta">&gt;&gt; </span>+ (char<span class="number">_</span> - <span class="string">'"'</span>) &gt;&gt; <span class="string">'"'</span>][_val = _1];</span><br></pre></td></tr></table></figure></p>
<p>Note: r %= p and r = p are equivalent if there are no semantic actions associated with p.</p>
<p>In case you are wondering, lit(“employee”) is the same as “employee”. We had to wrap it inside lit because immediately after it is &gt;&gt; ‘{‘. You can’t right-shift a char[] and a char - you know, C++ syntax rules.</p>
<h2 id="Karma-Writing-Generators"><a href="#Karma-Writing-Generators" class="headerlink" title="Karma - Writing Generators"></a>Karma - Writing Generators</h2><h3 id="Spirit-Karma-what’s-that"><a href="#Spirit-Karma-what’s-that" class="headerlink" title="Spirit.Karma - what’s that?"></a>Spirit.Karma - what’s that?</h3><p>Spirit.Karma is the counterpart to spirit.qi.<br>Some people say it’s the Yin to Spirit.Qi’s Yang. Spirit.karma is generating byte sequences from internal data structures as Spirit.Qi is parsing byte sequences into those internal data structures.</p>
<p>Why should you use a generator library for such a simple thing as output generation? Programmers have been using printf, std::stream formatting, or boost::format for quite some time. The answer is - yes, for simple output formatting tasks those familiar tools might be a quick solution. But experience shows: as soon as the formatting requirements are becoming more complex output generation is getting more and more challenging in terms of readability, maintainability, and flexibility of the code. Last, but not least, it turns out that code using Spirit.Karma runs much faster than equivalent code using either of the ‘straight’ methods mentioned above.</p>
<p>In terms of development simplicity and ease in deployment, the same is true for Spirit.Karma as has been described elsewhere in this documentation for Spirit.Qi: the entire library consists of only header files, with no libraries to link against or build. Just put the spirit distribution in your include path, compile and run. Code size? Very tight, essentially comparable to hand written code.</p>
<h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h3><h4 id="Trivial-Example-Generating-a-number"><a href="#Trivial-Example-Generating-a-number" class="headerlink" title="Trivial Example Generating a number"></a>Trivial Example Generating a number</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double_</span><br></pre></td></tr></table></figure>
<h4 id="Generating-two-numbers"><a href="#Generating-two-numbers" class="headerlink" title="Generating two numbers"></a>Generating two numbers</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">double_</span> &lt;&lt; double_</span><br></pre></td></tr></table></figure>
<h4 id="Generating-one-or-more-numbers"><a href="#Generating-one-or-more-numbers" class="headerlink" title="Generating one or more numbers"></a>Generating one or more numbers</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">*double_</span></span><br></pre></td></tr></table></figure>
<h4 id="Generating-a-comma-delimited-list-of-numbers"><a href="#Generating-a-comma-delimited-list-of-numbers" class="headerlink" title="Generating a comma-delimited list of numbers"></a>Generating a comma-delimited list of numbers</h4><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double_ &lt;&lt; *(<span class="name">lit</span>(',')) &lt;&lt; double_</span><br></pre></td></tr></table></figure>
<h4 id="Let’s-generate"><a href="#Let’s-generate" class="headerlink" title="Let’s generate"></a>Let’s generate</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> OutputIterator&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">generate_numbers</span><span class="params">(OutputIterator&amp; sink,<span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">double</span>&gt; <span class="keyword">const</span>&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> karma::double_;</span><br><span class="line">    <span class="keyword">using</span> karma::generate_delimited;</span><br><span class="line">    <span class="keyword">using</span> ascii::space;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">bool</span> r = genated_delimited(</span><br><span class="line">        sink,</span><br><span class="line">        double_ &lt;&lt; *(<span class="string">','</span> &lt;&lt; double_),</span><br><span class="line">        v</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/03/28/OpenMp-Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/28/OpenMp-Tutorial/" itemprop="url">OpenMp Tutorial</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-28T14:51:50+08:00">
                2018-03-28
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-03-29T15:07:57+08:00">
                2018-03-29
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-openmp"><a href="#What-is-openmp" class="headerlink" title="What is openmp"></a>What is openmp</h1><p>easy multithreading programing for c++.</p>
<p>it is a simple C/C++/Fortran complier extension that allows to add parallelism into existing source code without significantly having to rewrite it.</p>
<h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><p>example for init an array<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; arr;</span><br><span class="line">    arr.reserve(<span class="number">1000</span>);</span><br><span class="line">    <span class="meta">#pargma omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arr[i] = i * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>you can compile it like this</p>
<blockquote>
<p>g++ tmp.cpp -fopenmp</p>
</blockquote>
<p>if you remove the #pragma lines,the result is still a valid C++ program that runs and dose the expected thing.<br>if the compiler encounters a #pragma that it dose not support,it will ignore it.</p>
<h1 id="The-syntax"><a href="#The-syntax" class="headerlink" title="The syntax"></a>The syntax</h1><h2 id="the-parallel-construct"><a href="#the-parallel-construct" class="headerlink" title="the parallel construct"></a>the parallel construct</h2><p>it creates a team of N threads(where N is the number of CPU cores by default) . after the statement, the threads join back into one.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// code inside thie region runs in parallel</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Loop-construct-for"><a href="#Loop-construct-for" class="headerlink" title="Loop construct: for"></a>Loop construct: for</h2><p>the for construct splits the for-loop so that each thread in the current team handles a different portion of the loop<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>;n&lt;<span class="number">10</span>;++n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" %d"</span>,n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:#pragma omp for onlt delegates portions of the loop for different threads in <strong><em>current team</em></strong>. a team is the group of threads excuting the program.At program start,the team only consists the main thread.<br>To create a new team of threads,you need to specify the parallel keyword<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>;n&lt;<span class="number">10</span>;n++) <span class="built_in">printf</span>(<span class="string">" %d"</span>,n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>or use<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pragma omp parallel <span class="keyword">for</span></span></span><br></pre></td></tr></table></figure></p>
<p>you can explicitly specify the number of threads to be created in the team. using <strong><em>num_threads</em></strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pragma omp parallel <span class="keyword">for</span> num_threads(3)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="scheduling"><a href="#scheduling" class="headerlink" title="scheduling"></a>scheduling</h3><p>The scheduling algorithm for the for-loop can explicity controlled</p>
<p>default<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pargma omp <span class="keyword">for</span> schedule(static)</span></span><br></pre></td></tr></table></figure></p>
<p>in the dynamic schedule,each thread ask the omp runtime library for an iteration number,then handles it.<br>the chunk size can also be specified to lessen the number of calls to the runtime library<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pargma omp <span class="keyword">parallel</span> <span class="keyword">for</span> schedule(<span class="keyword">dynamic</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="the-ordered-clause"><a href="#the-ordered-clause" class="headerlink" title="the ordered clause"></a>the ordered clause</h3><p>it is possible to force that certain events within the loop happen in a predicted order, using ordered clause<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pargma</span> <span class="selector-tag">omp</span> <span class="selector-tag">parallel</span> <span class="selector-tag">for</span> <span class="selector-tag">ordered</span> <span class="selector-tag">shcedule</span>(dynamic)</span><br><span class="line"><span class="selector-tag">for</span>(int n = <span class="number">0</span>;i &lt; <span class="number">100</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">files</span><span class="selector-attr">[n]</span><span class="selector-class">.compress</span>();</span><br><span class="line">    <span class="selector-id">#pragma</span> <span class="selector-tag">omp</span> <span class="selector-tag">ordered</span></span><br><span class="line">    <span class="selector-tag">send</span>(files[n]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="the-collapse-clause"><a href="#the-collapse-clause" class="headerlink" title="the collapse clause"></a>the collapse clause</h3><p>when you have nested loops.you can use collapse<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pargma omp parallel for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">10</span>;j++)</span><br><span class="line">    &#123;</span><br><span class="line">        doSth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="section"><a href="#section" class="headerlink" title="section"></a>section</h2><p>sometimes,it is handy to indicate that “this and this can run in parallel” the sectiongs is just for that<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">#pragma omp parallel sections</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work1</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">#pragma omp section</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work2</span><span class="comment">()</span>;</span><br><span class="line">        work<span class="number">3</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">#pragma omp section</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work4</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This code indicates that any of tasks work1,work2+work3,work4 can run in parallel.</p>
<h1 id="Thread-safety"><a href="#Thread-safety" class="headerlink" title="Thread-safety"></a>Thread-safety</h1><h2 id="Atomicity"><a href="#Atomicity" class="headerlink" title="Atomicity"></a>Atomicity</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic</span></span><br><span class="line">couter += <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>
<p>the atomic keyword in OpenMP specifies that denoted action happens atomically.</p>
<h3 id="atomic-read-expression"><a href="#atomic-read-expression" class="headerlink" title="atomic read expression"></a>atomic read expression</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic read</span></span><br><span class="line"><span class="keyword">var</span> = x;</span><br></pre></td></tr></table></figure>
<h3 id="atomic-write-expression"><a href="#atomic-write-expression" class="headerlink" title="atomic write expression"></a>atomic write expression</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp atomic write</span></span><br><span class="line"><span class="attr">x</span> = expr;</span><br></pre></td></tr></table></figure>
<h3 id="atomic-update-expression"><a href="#atomic-update-expression" class="headerlink" title="atomic update expression"></a>atomic update expression</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma</span> <span class="comment">omp</span> <span class="comment">atomic</span> <span class="comment">update</span></span><br><span class="line"><span class="comment"></span><span class="literal">+</span><span class="literal">+</span><span class="comment">x;</span><span class="literal">-</span><span class="literal">-</span><span class="comment">x;x</span><span class="literal">+</span><span class="literal">+</span><span class="comment">;x</span><span class="literal">-</span><span class="literal">-</span><span class="comment">;</span></span><br><span class="line"><span class="comment"></span><span class="literal">+</span><span class="comment">=</span><span class="string">,</span><span class="literal">-</span><span class="comment">=</span> <span class="string">.</span><span class="string">.</span><span class="string">.</span></span><br></pre></td></tr></table></figure>
<h3 id="atomic-capture-expression"><a href="#atomic-capture-expression" class="headerlink" title="atomic capture expression"></a>atomic capture expression</h3><p>capture expression combine the read and update features<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic capture</span></span><br><span class="line"><span class="keyword">var</span> = x++;</span><br></pre></td></tr></table></figure></p>
<h2 id="the-critical-construct"><a href="#the-critical-construct" class="headerlink" title="the critical construct"></a>the critical construct</h2><p>the critical construct restricts the execution of the associated statement / block to a single thread at a time<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp critical</span></span><br><span class="line">&#123;</span><br><span class="line">    doSth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:the critical section names are global to the entire program.</p>
<h2 id="locks"><a href="#locks" class="headerlink" title="locks"></a>locks</h2><p>The openmp runtime library provides a lock type,omp_lock_t in omp.h<br>the lock type has five manipulator functions</p>
<blockquote>
<p>omp_init_lock : initializes the lock<br>omp_destory_lock : the lock must be unset before the call<br>omp_set_lock: get the lock<br>omp_unset_lock: release the lock<br>omp_test_lock: attempts to set the lock.if the lock is already set by another thread it returns 0;if it managed to set the lock,it return 1</p>
</blockquote>
<h2 id="the-flush-directive"><a href="#the-flush-directive" class="headerlink" title="the flush directive"></a>the flush directive</h2><p>Even when variables used by threads are supposed to be shared,the compiler may take liberties and optimize them as register variables. This can skew concurrent observations of variable. The flush directive can be used to forbid this.<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*first thread*/</span></span><br><span class="line"><span class="attr">b=1;</span></span><br><span class="line"><span class="comment">#pragma omp flush(a,b)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="attr">a</span> == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* critical section*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*second thread*/</span></span><br><span class="line"><span class="attr">a</span> = <span class="number">1</span>;</span><br><span class="line"><span class="comment">#pragma omp flush(a,b)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="attr">b==0)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">/* critical section*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Controlling-which-data-to-share-between-threads"><a href="#Controlling-which-data-to-share-between-threads" class="headerlink" title="Controlling which data to share between threads"></a>Controlling which data to share between threads</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int a,<span class="keyword">b </span>=<span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="comment">#pragma omp parallel for private(a) shared(b)</span></span><br><span class="line">for(a=<span class="number">0</span><span class="comment">;a&lt;50;++a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#pragma omp atomic</span></span><br><span class="line">    <span class="keyword">b </span>+= a<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a is private(each thread has their own copy of it) and b is shared(each thread accesses the same variable)</p>
<p>the difference between private and firstprivate<br>private does not copy the value of the variable that was in the surrounding context.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> a = <span class="string">"x"</span>,b=<span class="string">"y"</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel private(a,c) shared(b) num_threads(2)</span></span><br><span class="line">    &#123;</span><br><span class="line">        a+=<span class="string">"k"</span>;</span><br><span class="line">        c+= <span class="number">7</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A is "</span> &lt;&lt; a &lt;&lt;<span class="string">", b is "</span>&lt;&lt; b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eaquls this below</span></span><br><span class="line">     OpenMP_thread_fork(<span class="number">2</span>);</span><br><span class="line">     &#123;                  <span class="comment">// Start new scope</span></span><br><span class="line">         <span class="built_in">std</span>::<span class="built_in">string</span> a; <span class="comment">// Note: It is a new local variable.</span></span><br><span class="line">         <span class="keyword">int</span> c;         <span class="comment">// This too.</span></span><br><span class="line">         a += <span class="string">"k"</span>;</span><br><span class="line">         c += <span class="number">7</span>;</span><br><span class="line">         <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A becomes ("</span> &lt;&lt; a &lt;&lt; <span class="string">"), b is ("</span> &lt;&lt; b &lt;&lt; <span class="string">")\n"</span>;</span><br><span class="line">     &#125;                  <span class="comment">// End of scope for the local variables</span></span><br><span class="line">     OpenMP_join();</span><br></pre></td></tr></table></figure></p>
<p>If you actually need a copy of the original value, use the firstprivate clause instead.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> a = <span class="string">"x"</span>, b = <span class="string">"y"</span>;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(a,c) shared(b) num_threads(2)</span></span><br><span class="line">    &#123;</span><br><span class="line">        a += <span class="string">"k"</span>;</span><br><span class="line">        c += <span class="number">7</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A becomes ("</span> &lt;&lt; a &lt;&lt; <span class="string">"), b is ("</span> &lt;&lt; b &lt;&lt; <span class="string">")\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Execution-synchronization"><a href="#Execution-synchronization" class="headerlink" title="Execution synchronization"></a>Execution synchronization</h1><h2 id="the-barrier-directive-and-the-nowait-clause"><a href="#the-barrier-directive-and-the-nowait-clause" class="headerlink" title="the barrier directive and the nowait clause"></a>the barrier directive and the nowait clause</h2><p>The barrier directive causes threads encoutering the barrier to wait until all the other threads in the same team have encountered the barrier.<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp parrllel</span></span><br><span class="line">&#123;</span><br><span class="line">    // all threads<span class="built_in"> execute </span>this</span><br><span class="line">    SomeCode();</span><br><span class="line">    <span class="comment">#pragma omp barrier</span></span><br><span class="line">    // all threads<span class="built_in"> execute </span>this,but<span class="built_in"> not </span>before all threads have finished executing SomeCode()</span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:there is an implicit barrier at the end of each parallel block,at the end of each section for statement</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10</span>; ++n) Work();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This line is not reached before the for-loop is completely finished</span></span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This line is reached only after all threads from</span></span><br><span class="line"><span class="comment">// the previous parallel block are finished.</span></span><br><span class="line">CodeContinues();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for nowait</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10</span>; ++n) Work();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This line may be reached while some threads are still executing the for-loop.</span></span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This line is reached only after all threads from</span></span><br><span class="line"><span class="comment">// the previous parallel block are finished.</span></span><br><span class="line">CodeContinues();</span><br></pre></td></tr></table></figure>
<h2 id="the-single-and-master-constructs"><a href="#the-single-and-master-constructs" class="headerlink" title="the single and master constructs"></a>the single and master constructs</h2><p>The single construct specifies that the given statement/block is executed by only one thread. It is unspecified which thread. Other threads skip the statement/block and wait at an implicit barrier at the end of the construct.<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">#pragma omp parallel</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line"><span class="attr">    Work1</span><span class="comment">()</span>;</span><br><span class="line">    <span class="attr">#pragma omp single</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        Work2</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Work<span class="number">3</span><span class="comment">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The master construct is similar, except that the statement/block is run by the master thread, and there is no implied barrier; other threads skip the construct without waiting.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">FindAnyNeedle</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* haystack, <span class="keyword">size_t</span> size, <span class="keyword">char</span> needle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* result = haystack+size;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> num_iterations=<span class="number">0</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> p = <span class="number">0</span>; p &lt; size; ++p)</span><br><span class="line">        &#123;</span><br><span class="line">            ++num_iterations;</span><br><span class="line">            <span class="keyword">if</span>(haystack[p] == needle)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp atomic write</span></span><br><span class="line">                result = haystack+p;</span><br><span class="line">                <span class="comment">// Signal cancellation.</span></span><br><span class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp cancel for</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// Check for cancellations signalled by other threads:</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp cancellation point for</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// All threads reach here eventually; sooner if the cancellation was signalled.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %u: %u iterations completed\n"</span>, omp_get_thread_num(), num_iterations);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Loop-nesting"><a href="#Loop-nesting" class="headerlink" title="Loop nesting"></a>Loop nesting</h1><p>this code will not do the excepted thing<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>; y&lt;<span class="number">25</span>; ++y)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>; x&lt;<span class="number">80</span>; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        tick(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>solution<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp parallel for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span>(int <span class="attribute">y</span>=0; y&lt;25; ++y)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(int <span class="attribute">x</span>=0; x&lt;80; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        tick(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Readmore"><a href="#Readmore" class="headerlink" title="Readmore"></a>Readmore</h1><p><a href="http://www.openmp.org/wp-content/uploads/openmp-4.5.pdf" target="_blank" rel="noopener">http://www.openmp.org/wp-content/uploads/openmp-4.5.pdf</a><br><a href="https://en.wikipedia.org/wiki/OpenMP" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/OpenMP</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="carbo06@163.com" />
            
              <p class="site-author-name" itemprop="name">carbo06@163.com</p>
              <p class="site-description motion-element" itemprop="description">About Linux C++ and routing algorithms.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ce39906" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ce39906@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Friends
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lambdae.github.io/" title="DingliYang" target="_blank">DingliYang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zsirkg.github.io/" title="SongZhang" target="_blank">SongZhang</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">carbo06@163.com</span>

  
</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

<script type="text/javascript" src="/live2d/script.js"></script>
<canvas id="live2dcanvas" width="300" height="400" class="live2d"></canvas>
<style>
  #live2dcanvas {
    position: fixed;
    left: 0px;
    z-index: 999;
    pointer-events: none;
    bottom: -50px;
  }
</style>
<script>loadlive2d("live2dcanvas"
,"/live2d/models/tororo.model.json",0.5)</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>
</html>
