<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/cat-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/cat-32x32.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Parallel Programing," />










<meta name="description" content="What is openmpeasy multithreading programing for c++. it is a simple C/C++/Fortran complier extension that allows to add parallelism into existing source code without significantly having to rewrite i">
<meta name="keywords" content="Parallel Programing">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenMp Tutorial">
<meta property="og:url" content="https://carbo06.github.io/2018/03/28/OpenMp-Tutorial/index.html">
<meta property="og:site_name" content="Carbon&#39;s Blog">
<meta property="og:description" content="What is openmpeasy multithreading programing for c++. it is a simple C/C++/Fortran complier extension that allows to add parallelism into existing source code without significantly having to rewrite i">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-03-29T07:07:57.059Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenMp Tutorial">
<meta name="twitter:description" content="What is openmpeasy multithreading programing for c++. it is a simple C/C++/Fortran complier extension that allows to add parallelism into existing source code without significantly having to rewrite i">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carbo06.github.io/2018/03/28/OpenMp-Tutorial/"/>





  <title>OpenMp Tutorial | Carbon's Blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Carbon's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">以梦为马 不负韶华</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carbo06.github.io/2018/03/28/OpenMp-Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="carbo06@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Carbon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenMp Tutorial</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-28T14:51:50+08:00">
                2018-03-28
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-03-29T15:07:57+08:00">
                2018-03-29
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Backend-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Backend Development</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/28/OpenMp-Tutorial/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2018/03/28/OpenMp-Tutorial/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="What-is-openmp"><a href="#What-is-openmp" class="headerlink" title="What is openmp"></a>What is openmp</h1><p>easy multithreading programing for c++.</p>
<p>it is a simple C/C++/Fortran complier extension that allows to add parallelism into existing source code without significantly having to rewrite it.</p>
<h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><p>example for init an array<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; arr;</span><br><span class="line">    arr.reserve(<span class="number">1000</span>);</span><br><span class="line">    <span class="meta">#pargma omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arr[i] = i * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>you can compile it like this</p>
<blockquote>
<p>g++ tmp.cpp -fopenmp</p>
</blockquote>
<p>if you remove the #pragma lines,the result is still a valid C++ program that runs and dose the expected thing.<br>if the compiler encounters a #pragma that it dose not support,it will ignore it.</p>
<h1 id="The-syntax"><a href="#The-syntax" class="headerlink" title="The syntax"></a>The syntax</h1><h2 id="the-parallel-construct"><a href="#the-parallel-construct" class="headerlink" title="the parallel construct"></a>the parallel construct</h2><p>it creates a team of N threads(where N is the number of CPU cores by default) . after the statement, the threads join back into one.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// code inside thie region runs in parallel</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Loop-construct-for"><a href="#Loop-construct-for" class="headerlink" title="Loop construct: for"></a>Loop construct: for</h2><p>the for construct splits the for-loop so that each thread in the current team handles a different portion of the loop<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>;n&lt;<span class="number">10</span>;++n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" %d"</span>,n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:#pragma omp for onlt delegates portions of the loop for different threads in <strong><em>current team</em></strong>. a team is the group of threads excuting the program.At program start,the team only consists the main thread.<br>To create a new team of threads,you need to specify the parallel keyword<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>;n&lt;<span class="number">10</span>;n++) <span class="built_in">printf</span>(<span class="string">" %d"</span>,n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>or use<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pragma omp parallel <span class="keyword">for</span></span></span><br></pre></td></tr></table></figure></p>
<p>you can explicitly specify the number of threads to be created in the team. using <strong><em>num_threads</em></strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pragma omp parallel <span class="keyword">for</span> num_threads(3)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="scheduling"><a href="#scheduling" class="headerlink" title="scheduling"></a>scheduling</h3><p>The scheduling algorithm for the for-loop can explicity controlled</p>
<p>default<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">pargma omp <span class="keyword">for</span> schedule(static)</span></span><br></pre></td></tr></table></figure></p>
<p>in the dynamic schedule,each thread ask the omp runtime library for an iteration number,then handles it.<br>the chunk size can also be specified to lessen the number of calls to the runtime library<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pargma omp <span class="keyword">parallel</span> <span class="keyword">for</span> schedule(<span class="keyword">dynamic</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="the-ordered-clause"><a href="#the-ordered-clause" class="headerlink" title="the ordered clause"></a>the ordered clause</h3><p>it is possible to force that certain events within the loop happen in a predicted order, using ordered clause<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pargma</span> <span class="selector-tag">omp</span> <span class="selector-tag">parallel</span> <span class="selector-tag">for</span> <span class="selector-tag">ordered</span> <span class="selector-tag">shcedule</span>(dynamic)</span><br><span class="line"><span class="selector-tag">for</span>(int n = <span class="number">0</span>;i &lt; <span class="number">100</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">files</span><span class="selector-attr">[n]</span><span class="selector-class">.compress</span>();</span><br><span class="line">    <span class="selector-id">#pragma</span> <span class="selector-tag">omp</span> <span class="selector-tag">ordered</span></span><br><span class="line">    <span class="selector-tag">send</span>(files[n]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="the-collapse-clause"><a href="#the-collapse-clause" class="headerlink" title="the collapse clause"></a>the collapse clause</h3><p>when you have nested loops.you can use collapse<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pargma omp parallel for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">10</span>;j++)</span><br><span class="line">    &#123;</span><br><span class="line">        doSth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="section"><a href="#section" class="headerlink" title="section"></a>section</h2><p>sometimes,it is handy to indicate that “this and this can run in parallel” the sectiongs is just for that<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">#pragma omp parallel sections</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work1</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">#pragma omp section</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work2</span><span class="comment">()</span>;</span><br><span class="line">        work<span class="number">3</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">#pragma omp section</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        work4</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This code indicates that any of tasks work1,work2+work3,work4 can run in parallel.</p>
<h1 id="Thread-safety"><a href="#Thread-safety" class="headerlink" title="Thread-safety"></a>Thread-safety</h1><h2 id="Atomicity"><a href="#Atomicity" class="headerlink" title="Atomicity"></a>Atomicity</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic</span></span><br><span class="line">couter += <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>
<p>the atomic keyword in OpenMP specifies that denoted action happens atomically.</p>
<h3 id="atomic-read-expression"><a href="#atomic-read-expression" class="headerlink" title="atomic read expression"></a>atomic read expression</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic read</span></span><br><span class="line"><span class="keyword">var</span> = x;</span><br></pre></td></tr></table></figure>
<h3 id="atomic-write-expression"><a href="#atomic-write-expression" class="headerlink" title="atomic write expression"></a>atomic write expression</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp atomic write</span></span><br><span class="line"><span class="attr">x</span> = expr;</span><br></pre></td></tr></table></figure>
<h3 id="atomic-update-expression"><a href="#atomic-update-expression" class="headerlink" title="atomic update expression"></a>atomic update expression</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma</span> <span class="comment">omp</span> <span class="comment">atomic</span> <span class="comment">update</span></span><br><span class="line"><span class="comment"></span><span class="literal">+</span><span class="literal">+</span><span class="comment">x;</span><span class="literal">-</span><span class="literal">-</span><span class="comment">x;x</span><span class="literal">+</span><span class="literal">+</span><span class="comment">;x</span><span class="literal">-</span><span class="literal">-</span><span class="comment">;</span></span><br><span class="line"><span class="comment"></span><span class="literal">+</span><span class="comment">=</span><span class="string">,</span><span class="literal">-</span><span class="comment">=</span> <span class="string">.</span><span class="string">.</span><span class="string">.</span></span><br></pre></td></tr></table></figure>
<h3 id="atomic-capture-expression"><a href="#atomic-capture-expression" class="headerlink" title="atomic capture expression"></a>atomic capture expression</h3><p>capture expression combine the read and update features<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp atomic capture</span></span><br><span class="line"><span class="keyword">var</span> = x++;</span><br></pre></td></tr></table></figure></p>
<h2 id="the-critical-construct"><a href="#the-critical-construct" class="headerlink" title="the critical construct"></a>the critical construct</h2><p>the critical construct restricts the execution of the associated statement / block to a single thread at a time<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp critical</span></span><br><span class="line">&#123;</span><br><span class="line">    doSth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:the critical section names are global to the entire program.</p>
<h2 id="locks"><a href="#locks" class="headerlink" title="locks"></a>locks</h2><p>The openmp runtime library provides a lock type,omp_lock_t in omp.h<br>the lock type has five manipulator functions</p>
<blockquote>
<p>omp_init_lock : initializes the lock<br>omp_destory_lock : the lock must be unset before the call<br>omp_set_lock: get the lock<br>omp_unset_lock: release the lock<br>omp_test_lock: attempts to set the lock.if the lock is already set by another thread it returns 0;if it managed to set the lock,it return 1</p>
</blockquote>
<h2 id="the-flush-directive"><a href="#the-flush-directive" class="headerlink" title="the flush directive"></a>the flush directive</h2><p>Even when variables used by threads are supposed to be shared,the compiler may take liberties and optimize them as register variables. This can skew concurrent observations of variable. The flush directive can be used to forbid this.<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*first thread*/</span></span><br><span class="line"><span class="attr">b=1;</span></span><br><span class="line"><span class="comment">#pragma omp flush(a,b)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="attr">a</span> == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* critical section*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*second thread*/</span></span><br><span class="line"><span class="attr">a</span> = <span class="number">1</span>;</span><br><span class="line"><span class="comment">#pragma omp flush(a,b)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="attr">b==0)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">/* critical section*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Controlling-which-data-to-share-between-threads"><a href="#Controlling-which-data-to-share-between-threads" class="headerlink" title="Controlling which data to share between threads"></a>Controlling which data to share between threads</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int a,<span class="keyword">b </span>=<span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="comment">#pragma omp parallel for private(a) shared(b)</span></span><br><span class="line">for(a=<span class="number">0</span><span class="comment">;a&lt;50;++a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#pragma omp atomic</span></span><br><span class="line">    <span class="keyword">b </span>+= a<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a is private(each thread has their own copy of it) and b is shared(each thread accesses the same variable)</p>
<p>the difference between private and firstprivate<br>private does not copy the value of the variable that was in the surrounding context.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> a = <span class="string">"x"</span>,b=<span class="string">"y"</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel private(a,c) shared(b) num_threads(2)</span></span><br><span class="line">    &#123;</span><br><span class="line">        a+=<span class="string">"k"</span>;</span><br><span class="line">        c+= <span class="number">7</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A is "</span> &lt;&lt; a &lt;&lt;<span class="string">", b is "</span>&lt;&lt; b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eaquls this below</span></span><br><span class="line">     OpenMP_thread_fork(<span class="number">2</span>);</span><br><span class="line">     &#123;                  <span class="comment">// Start new scope</span></span><br><span class="line">         <span class="built_in">std</span>::<span class="built_in">string</span> a; <span class="comment">// Note: It is a new local variable.</span></span><br><span class="line">         <span class="keyword">int</span> c;         <span class="comment">// This too.</span></span><br><span class="line">         a += <span class="string">"k"</span>;</span><br><span class="line">         c += <span class="number">7</span>;</span><br><span class="line">         <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A becomes ("</span> &lt;&lt; a &lt;&lt; <span class="string">"), b is ("</span> &lt;&lt; b &lt;&lt; <span class="string">")\n"</span>;</span><br><span class="line">     &#125;                  <span class="comment">// End of scope for the local variables</span></span><br><span class="line">     OpenMP_join();</span><br></pre></td></tr></table></figure></p>
<p>If you actually need a copy of the original value, use the firstprivate clause instead.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> a = <span class="string">"x"</span>, b = <span class="string">"y"</span>;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(a,c) shared(b) num_threads(2)</span></span><br><span class="line">    &#123;</span><br><span class="line">        a += <span class="string">"k"</span>;</span><br><span class="line">        c += <span class="number">7</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A becomes ("</span> &lt;&lt; a &lt;&lt; <span class="string">"), b is ("</span> &lt;&lt; b &lt;&lt; <span class="string">")\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Execution-synchronization"><a href="#Execution-synchronization" class="headerlink" title="Execution synchronization"></a>Execution synchronization</h1><h2 id="the-barrier-directive-and-the-nowait-clause"><a href="#the-barrier-directive-and-the-nowait-clause" class="headerlink" title="the barrier directive and the nowait clause"></a>the barrier directive and the nowait clause</h2><p>The barrier directive causes threads encoutering the barrier to wait until all the other threads in the same team have encountered the barrier.<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp parrllel</span></span><br><span class="line">&#123;</span><br><span class="line">    // all threads<span class="built_in"> execute </span>this</span><br><span class="line">    SomeCode();</span><br><span class="line">    <span class="comment">#pragma omp barrier</span></span><br><span class="line">    // all threads<span class="built_in"> execute </span>this,but<span class="built_in"> not </span>before all threads have finished executing SomeCode()</span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:there is an implicit barrier at the end of each parallel block,at the end of each section for statement</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10</span>; ++n) Work();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This line is not reached before the for-loop is completely finished</span></span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This line is reached only after all threads from</span></span><br><span class="line"><span class="comment">// the previous parallel block are finished.</span></span><br><span class="line">CodeContinues();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp for nowait</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>; n&lt;<span class="number">10</span>; ++n) Work();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This line may be reached while some threads are still executing the for-loop.</span></span><br><span class="line">    SomeMoreCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This line is reached only after all threads from</span></span><br><span class="line"><span class="comment">// the previous parallel block are finished.</span></span><br><span class="line">CodeContinues();</span><br></pre></td></tr></table></figure>
<h2 id="the-single-and-master-constructs"><a href="#the-single-and-master-constructs" class="headerlink" title="the single and master constructs"></a>the single and master constructs</h2><p>The single construct specifies that the given statement/block is executed by only one thread. It is unspecified which thread. Other threads skip the statement/block and wait at an implicit barrier at the end of the construct.<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">#pragma omp parallel</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line"><span class="attr">    Work1</span><span class="comment">()</span>;</span><br><span class="line">    <span class="attr">#pragma omp single</span></span><br><span class="line"><span class="attr">    &#123;</span></span><br><span class="line"><span class="attr">        Work2</span><span class="comment">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Work<span class="number">3</span><span class="comment">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The master construct is similar, except that the statement/block is run by the master thread, and there is no implied barrier; other threads skip the construct without waiting.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">FindAnyNeedle</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* haystack, <span class="keyword">size_t</span> size, <span class="keyword">char</span> needle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* result = haystack+size;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> num_iterations=<span class="number">0</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp for</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> p = <span class="number">0</span>; p &lt; size; ++p)</span><br><span class="line">        &#123;</span><br><span class="line">            ++num_iterations;</span><br><span class="line">            <span class="keyword">if</span>(haystack[p] == needle)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp atomic write</span></span><br><span class="line">                result = haystack+p;</span><br><span class="line">                <span class="comment">// Signal cancellation.</span></span><br><span class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> omp cancel for</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// Check for cancellations signalled by other threads:</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">pragma</span> omp cancellation point for</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// All threads reach here eventually; sooner if the cancellation was signalled.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %u: %u iterations completed\n"</span>, omp_get_thread_num(), num_iterations);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Loop-nesting"><a href="#Loop-nesting" class="headerlink" title="Loop nesting"></a>Loop nesting</h1><p>this code will not do the excepted thing<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>; y&lt;<span class="number">25</span>; ++y)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>; x&lt;<span class="number">80</span>; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        tick(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>solution<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma omp parallel for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span>(int <span class="attribute">y</span>=0; y&lt;25; ++y)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(int <span class="attribute">x</span>=0; x&lt;80; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        tick(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Readmore"><a href="#Readmore" class="headerlink" title="Readmore"></a>Readmore</h1><p><a href="http://www.openmp.org/wp-content/uploads/openmp-4.5.pdf" target="_blank" rel="noopener">http://www.openmp.org/wp-content/uploads/openmp-4.5.pdf</a><br><a href="https://en.wikipedia.org/wiki/OpenMP" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/OpenMP</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="carbo06@163.com 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="carbo06@163.com 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Parallel-Programing/" rel="tag"># Parallel Programing</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/28/Boost-Spirit/" rel="prev" title="Boost Spirit">
                Boost Spirit <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="carbo06@163.com" />
            
              <p class="site-author-name" itemprop="name">carbo06@163.com</p>
              <p class="site-description motion-element" itemprop="description">About Linux C++ and routing algorithms.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ce39906" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ce39906@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Friends
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lambdae.github.io/" title="DingliYang" target="_blank">DingliYang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zsirkg.github.io/" title="SongZhang" target="_blank">SongZhang</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-openmp"><span class="nav-number">1.</span> <span class="nav-text">What is openmp</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Example"><span class="nav-number">2.</span> <span class="nav-text">Example</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-syntax"><span class="nav-number">3.</span> <span class="nav-text">The syntax</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-parallel-construct"><span class="nav-number">3.1.</span> <span class="nav-text">the parallel construct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loop-construct-for"><span class="nav-number">3.2.</span> <span class="nav-text">Loop construct: for</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduling"><span class="nav-number">3.2.1.</span> <span class="nav-text">scheduling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#the-ordered-clause"><span class="nav-number">3.2.2.</span> <span class="nav-text">the ordered clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#the-collapse-clause"><span class="nav-number">3.2.3.</span> <span class="nav-text">the collapse clause</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#section"><span class="nav-number">3.3.</span> <span class="nav-text">section</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Thread-safety"><span class="nav-number">4.</span> <span class="nav-text">Thread-safety</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Atomicity"><span class="nav-number">4.1.</span> <span class="nav-text">Atomicity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#atomic-read-expression"><span class="nav-number">4.1.1.</span> <span class="nav-text">atomic read expression</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#atomic-write-expression"><span class="nav-number">4.1.2.</span> <span class="nav-text">atomic write expression</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#atomic-update-expression"><span class="nav-number">4.1.3.</span> <span class="nav-text">atomic update expression</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#atomic-capture-expression"><span class="nav-number">4.1.4.</span> <span class="nav-text">atomic capture expression</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-critical-construct"><span class="nav-number">4.2.</span> <span class="nav-text">the critical construct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#locks"><span class="nav-number">4.3.</span> <span class="nav-text">locks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-flush-directive"><span class="nav-number">4.4.</span> <span class="nav-text">the flush directive</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Controlling-which-data-to-share-between-threads"><span class="nav-number">5.</span> <span class="nav-text">Controlling which data to share between threads</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Execution-synchronization"><span class="nav-number">6.</span> <span class="nav-text">Execution synchronization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-barrier-directive-and-the-nowait-clause"><span class="nav-number">6.1.</span> <span class="nav-text">the barrier directive and the nowait clause</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-single-and-master-constructs"><span class="nav-number">6.2.</span> <span class="nav-text">the single and master constructs</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Loop-nesting"><span class="nav-number">7.</span> <span class="nav-text">Loop nesting</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Readmore"><span class="nav-number">8.</span> <span class="nav-text">Readmore</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">carbo06@163.com</span>

  
</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: decodeURI(window.location.pathname).substring(0,20), 
            owner: 'carbo06',
            repo: 'gitment',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'cb86e5ac2c3dba18be1c7815742a4f761de98fe7',
            
                client_id: '70728960b33c81e406d0'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

<script type="text/javascript" src="/live2d/script.js"></script>
<canvas id="live2dcanvas" width="300" height="400" class="live2d"></canvas>
<style>
  #live2dcanvas {
    position: fixed;
    left: 0px;
    z-index: 999;
    pointer-events: none;
    bottom: -50px;
  }
</style>
<script>loadlive2d("live2dcanvas"
,"/live2d/models/tororo.model.json",0.5)</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>
</html>
